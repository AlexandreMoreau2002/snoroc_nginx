name: Deploy Nginx Configuration

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run basic validation
        run: |
          chmod +x scripts/test.sh
          ./scripts/test.sh

      - name: Install Nginx for syntax validation
        run: |
          sudo apt-get update
          sudo apt-get install -y nginx openssl

      - name: Prepare Nginx sandbox
        run: |
          # Prepare folders expected by the site configs
          sudo mkdir -p /etc/nginx/sites-available /etc/nginx/sites-enabled /etc/nginx/snippets
          sudo mkdir -p /etc/letsencrypt/live/snoroc.fr /etc/letsencrypt/live/dev.snoroc.fr
          sudo cp nginx/snippets/* /etc/nginx/snippets/
          sudo cp nginx/sites/snoroc.conf /etc/nginx/sites-available/snoroc.conf
          sudo cp nginx/sites/snoroc-dev.conf /etc/nginx/sites-available/snoroc-dev.conf
          sudo ln -sf /etc/nginx/sites-available/snoroc.conf /etc/nginx/sites-enabled/snoroc.conf
          sudo ln -sf /etc/nginx/sites-available/snoroc-dev.conf /etc/nginx/sites-enabled/snoroc-dev.conf

          # Fake certificates/params so nginx -t can run
          echo 'ssl_session_cache shared:le_nginx_SSL:1m;' | sudo tee /etc/letsencrypt/options-ssl-nginx.conf >/dev/null
          sudo openssl req -x509 -nodes -days 1 -newkey rsa:2048 -subj "/CN=snoroc.fr" \
            -keyout /etc/letsencrypt/live/snoroc.fr/privkey.pem \
            -out /etc/letsencrypt/live/snoroc.fr/fullchain.pem
          sudo openssl req -x509 -nodes -days 1 -newkey rsa:2048 -subj "/CN=dev.snoroc.fr" \
            -keyout /etc/letsencrypt/live/dev.snoroc.fr/privkey.pem \
            -out /etc/letsencrypt/live/dev.snoroc.fr/fullchain.pem
          sudo openssl dhparam -out /etc/letsencrypt/ssl-dhparams.pem 2048

          # Minimal nginx.conf to validate sites + rate limits
          cat <<'EOF' | sudo tee /tmp/nginx.conf >/dev/null
          user www-data;
          worker_processes auto;
          pid /run/nginx.pid;

          events {
              worker_connections 1024;
          }

          http {
              include /etc/nginx/mime.types;
              default_type application/octet-stream;
              include /etc/nginx/snippets/rate-limit.conf;
              include /etc/nginx/sites-enabled/*;
          }
          EOF

      - name: Validate Nginx syntax
        run: sudo nginx -t -c /tmp/nginx.conf

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: validate
    environment: snoroc-nginx
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy configuration files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ vars.SERVER_HOST }}
          username: ${{ vars.SERVER_USER }}
          key: ${{ vars.SERVER_SSH_KEY }}
          port: ${{ vars.SERVER_PORT }}
          source: "nginx,scripts"
          target: ${{ vars.DEPLOY_TEMP_DIR }}
          strip_components: 0

      - name: Execute deployment script
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.SERVER_HOST }}
          username: ${{ vars.SERVER_USER }}
          key: ${{ vars.SERVER_SSH_KEY }}
          port: ${{ vars.SERVER_PORT }}
          script: |
            cd ${{ vars.DEPLOY_TEMP_DIR }}
            chmod +x scripts/deploy.sh
            sudo ./scripts/deploy.sh
            
            cd /
            rm -rf ${{ vars.DEPLOY_TEMP_DIR }}

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.SERVER_HOST }}
          username: ${{ vars.SERVER_USER }}
          key: ${{ vars.SERVER_SSH_KEY }}
          port: ${{ vars.SERVER_PORT }}
          script: |
            echo "Checking Nginx status..."
            sudo systemctl status nginx --no-pager
            echo ""
            echo "Testing configuration..."
            sudo nginx -t

  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: deploy
    environment: snoroc-nginx
    
    steps:
      - name: Wait for stabilization
        run: |
          echo "‚è≥ Attente de 5 secondes pour stabilisation..."
          sleep 5

      - name: Check dev site (non bloquant)
        continue-on-error: true
        run: |
          SITE="${{ vars.SITE_URL_DEV }}"
          echo "üîç V√©rification de https://$SITE..."
          
          STATUS_CODE=$(curl -o /dev/null -s -w "%{http_code}" "https://$SITE")
          if [ "$STATUS_CODE" != "200" ]; then
            echo "‚ö†Ô∏è  $SITE r√©pond avec HTTP $STATUS_CODE (non bloquant)"
            exit 1
          fi
          echo "‚úÖ $SITE - HTTP 200 OK"
          
          CONTENT=$(curl -s "https://$SITE")
          if echo "$CONTENT" | grep -qiE "nginx error|Bad Gateway|Welcome to nginx|403 Forbidden|404 Not Found"; then
            echo "‚ö†Ô∏è  $SITE renvoie une page d'erreur (non bloquant)"
            exit 1
          fi
          echo "‚úÖ $SITE - Contenu valide"

      - name: Check prod site
        run: |
          SITE="${{ vars.SITE_URL }}"
          echo "üîç V√©rification de https://$SITE..."
          
          STATUS_CODE=$(curl -o /dev/null -s -w "%{http_code}" "https://$SITE")
          if [ "$STATUS_CODE" != "200" ]; then
            echo "‚ùå $SITE r√©pond avec HTTP $STATUS_CODE"
            exit 1
          fi
          echo "‚úÖ $SITE - HTTP 200 OK"
          
          CONTENT=$(curl -s "https://$SITE")
          if echo "$CONTENT" | grep -qiE "nginx error|Bad Gateway|Welcome to nginx|403 Forbidden|404 Not Found"; then
            echo "‚ùå $SITE renvoie une page d'erreur"
            exit 1
          fi
          echo "‚úÖ $SITE - Contenu valide"

      - name: Deployment success
        run: |
          echo "üéâ D√©ploiement valid√© avec succ√®s !"
          echo "‚úÖ DEV: https://${{ vars.SITE_URL_DEV }}"
          echo "‚úÖ PROD: https://${{ vars.SITE_URL }}"
